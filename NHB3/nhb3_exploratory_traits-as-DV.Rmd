---
title: "Exploratory Analyses NHB3: Evaluative traits as DV"
author: "Youssef Amin and Angelika Stefan"
output: html_document
---

## Why this exploratory analysis?

Our reliability analyses revealed that our combined measure for intergroup bias has an inadequate internal consistency. As preregistered, we therefore compute our main hypothesis tests with each of the scales separately. Here, we compute the confirmatory hypothesis tests with the __difference in ingroup and outgroup trait evaluation__ as a dependent variable. 

## Load packages

```{r setup}
library(brms)
library(bayestestR)
library(emmeans)
```

## Read in data

```{r}
nhb3 <- read.csv('../../data/nhb3_processed.csv')
```

## Testing ideological asymmetry in intergroup bias

### Model fitting

```{r}
# Define model equation
exploratory1_formula <- z_ingroup_minus_outgroup_traits_positive ~ composite_political_orientation_z

# Fit frequentist model
exploratory1_freqmodel <- lm(exploratory1_formula, nhb3)

# Fit Bayesian models
exploratory1_default_priors <- c(set_prior("normal(0, 0.5)", class = "b"))
exploratory1_informed_priors <- c(set_prior("normal(0.15, 0.05)", class = "b"))

exploratory1_bayesmodel_default <- brm(
  formula = exploratory1_formula, 
  data = nhb3, 
  family = gaussian(),
  prior = exploratory1_default_priors,
  sample_prior = "no",
  iter = 100000,
  chains = 4,
  seed = 987654,
  # silent = TRUE,
  # refresh = 0,
  warmup = 5000,
  file = "./model-fits/nhb3/exploratory1_bayesmodel_default_traits-as-DV"
  )

exploratory1_priordraws_default<- brm(
  exploratory1_formula,
  data = nhb3,
  family = "gaussian",
  prior = exploratory1_default_priors,
  sample_prior = "only",
  seed = 987654,
  # silent = TRUE,
  # refresh = 0,
  iter = 100000,
  file = "./model-fits/nhb3/exploratory1_bayesmodel_priordraws_default_traits-as-DV"
  )
                            
exploratory1_bayesmodel_informed <- brm(
  formula = exploratory1_formula, 
  data = nhb3, 
  family = gaussian(),
  prior = exploratory1_informed_priors,
  sample_prior = "no",
  iter = 100000,
  chains = 4,
  seed = 987654,
  # silent = TRUE,
  # refresh = 0,
  warmup = 5000,
  file = "./model-fits/nhb3/exploratory1_bayesmodel_informed_traits-as-DV"
  )

exploratory1_priordraws_informed<- brm(
  exploratory1_formula,
  data = nhb3,
  family = "gaussian",
  prior = exploratory1_informed_priors,
  sample_prior = "only",
  seed = 987654,
  # silent = TRUE,
  # refresh = 0,
  iter = 100000,
  file = "./model-fits/nhb3/exploratory1_bayesmodel_priordraws_informed_traits-as-DV"
  )                            
```

### Model summaries

```{r}
summary(exploratory1_freqmodel)
summary(exploratory1_bayesmodel_default)
summary(exploratory1_bayesmodel_informed)
```

### Hypothesis test

Frequentist quantities

```{r}
# Coefficient estimate
coef1_freq <- exploratory1_freqmodel$coefficients["composite_political_orientation_z"]

# Confidence interval
confint1_freq <- confint(exploratory1_freqmodel, "composite_political_orientation_z")
confint90_freq <- confint(exploratory1_freqmodel, "composite_political_orientation_z", level = 0.90)

# p-Value (computed manually as one-sided p-value)
df_confirm1 <- exploratory1_freqmodel$df.residual
t_confirm1 <- exploratory1_freqmodel$coefficients[["composite_political_orientation_z"]]/summary(exploratory1_freqmodel)$coefficients["composite_political_orientation_z","Std. Error"]
p_confirm1 <- 1-pt(t_confirm1, df_confirm1)

data.frame("beta_z" = round(coef1_freq, 2),
           "CI_lower_95" = round(confint1_freq[1], 2),
           "CI_upper_95" = round(confint1_freq[2], 2),
           "CI_lower_90" = round(confint90_freq[1], 2),
           "CI_upper_90" = round(confint90_freq[2], 2),
           "p value" = round(p_confirm1, 3))
```

Bayesian quantities

```{r}
# Coefficient estimate
coef1_bayes_default <- fixef(exploratory1_bayesmodel_default)["composite_political_orientation_z", "Estimate"]
coef1_bayes_informed <- fixef(exploratory1_bayesmodel_informed)["composite_political_orientation_z", "Estimate"]

# Credible interval
cred1_bayes_default <- fixef(exploratory1_bayesmodel_default)["composite_political_orientation_z", c("Q2.5", "Q97.5")]
cred90_bayes_default <- fixef(exploratory1_bayesmodel_default, probs = c(0.05, 0.95))["composite_political_orientation_z", c("Q5", "Q95")]
cred1_bayes_informed <- fixef(exploratory1_bayesmodel_informed)["composite_political_orientation_z", c("Q2.5", "Q97.5")]
cred90_bayes_informed <- fixef(exploratory1_bayesmodel_informed, probs = c(0.05, 0.95))["composite_political_orientation_z", c("Q5", "Q95")]

# Bayes factor
exploratory1_bf_default <- bayesfactor_parameters(
  exploratory1_bayesmodel_default,
  prior=exploratory1_priordraws_default,
  direction = "right", 
  parameters = "composite_political_orientation_z")

exploratory1_bf_informed <- bayesfactor_parameters(
  exploratory1_bayesmodel_informed,
  prior=exploratory1_priordraws_informed,
  direction = "right", 
  parameters = "composite_political_orientation_z")
                       
# Posterior probability > .10
postProb_default <- hypothesis(exploratory1_bayesmodel_default, "composite_political_orientation_z > 0.10")$hypothesis$Post.Prob
postProb_informed <- hypothesis(exploratory1_bayesmodel_informed, "composite_political_orientation_z > 0.10")$hypothesis$Post.Prob

data.frame("prior" = c("default", "informed"),
           "beta_z" = round(c(coef1_bayes_default, coef1_bayes_informed), 2),
           "CI_lower_95" = round(c(cred1_bayes_default[1], cred1_bayes_informed[1]), 2),
           "CI_upper_95" = round(c(cred1_bayes_default[2], cred1_bayes_informed[2]), 2),
           "CI_lower_90" = round(c(cred90_bayes_default[1], cred90_bayes_informed[1]), 2),
           "CI_upper_90" = round(c(cred90_bayes_default[2], cred90_bayes_informed[2]), 2),
           "BFplus0" = round(c(exp(exploratory1_bf_default$log_BF), exp(exploratory1_bf_informed$log_BF)), 2),
           "PostProb" = round(c(postProb_default, postProb_informed), 2))
```


## Testing the moderating effect of group type (control, cooperative, competitive)

### Model fitting

```{r}
nhb3$condition <- factor(nhb3$condition, 
                         levels = c("no_interaction", "competitive", "cooperative"),
                         labels = c("Control", "Competitive", "Cooperative"))

# Define model equation
exploratory2_formula <- z_ingroup_minus_outgroup_traits_positive ~ composite_political_orientation_z * condition

# Fit frequentist model
exploratory2_freqmodel <- lm(exploratory2_formula, data = nhb3)

# Fit Bayesian models

exploratory2_default_priors <- c(
  set_prior("normal(0, 0.5)", class = "b", coef="composite_political_orientation_z"),
  set_prior("normal(0, 0.5)", class = "b", coef="conditionCompetitive"),
  set_prior("normal(0, 0.5)", class = "b", coef="conditionCooperative"),
  set_prior("normal(0, 0.2)", class = "b", coef="composite_political_orientation_z:conditionCompetitive"),
  set_prior("normal(0, 0.2)", class = "b", coef="composite_political_orientation_z:conditionCooperative")
  )

exploratory2_informed_priors <- c(
  set_prior("normal(0.15, 0.05)", class = "b", coef="composite_political_orientation_z"),
  set_prior("normal(0.1, 0.05)", class = "b", coef="conditionCompetitive"),
  set_prior("normal(0.1, 0.05)", class = "b", coef="conditionCooperative"),
  set_prior("normal(0.1, 0.05)", class = "b", coef="composite_political_orientation_z:conditionCompetitive"),
  set_prior("normal(0.1, 0.05)", class = "b", coef="composite_political_orientation_z:conditionCooperative")
  )

exploratory2_bayesmodel_default <- brms::brm(
  formula = exploratory2_formula,
  data = nhb3,
  family = "gaussian",
  prior = exploratory2_default_priors,
  iter = 100000,
  chains = 4,
  seed = 987654,
  silent = TRUE,
  refresh = 0,
  warmup = 5000,
  file = "./model-fits/nhb3/exploratory2_bayesmodel_default_traits-as-DV"
)

exploratory2_priordraws_default <- brms::brm(
  exploratory2_formula,
  data = nhb3, 
  family = "gaussian",
  prior = exploratory2_default_priors,
  sample_prior = "only",
  seed = 987654,
  silent = TRUE,
  refresh = 0,
  iter = 100000,
  file = "./model-fits/nhb3/exploratory2_bayesmodel_priordraws_default_traits-as-DV")

exploratory2_bayesmodel_informed <- brms::brm(
  formula = exploratory2_formula,
  data = nhb3,
  family = "gaussian",
  prior = exploratory2_informed_priors,
  iter = 100000,
  chains = 4,
  seed = 987654,
  silent = TRUE,
  refresh = 0,
  warmup = 5000,
  file = "./model-fits/nhb3/exploratory2_bayesmodel_informed_traits-as-DV"
)

exploratory2_priordraws_informed <- brms::brm(
  exploratory2_formula,
  data = nhb3, 
  family = "gaussian",
  prior = exploratory2_informed_priors,
  sample_prior = "only",
  seed = 987654,
  silent = TRUE,
  refresh = 0,
  iter = 100000,
  file = "./model-fits/nhb3/exploratory2_bayesmodel_priordraws_informed_traits-as-DV")

```

### Model summaries

```{r}
summary(exploratory2_freqmodel)
summary(exploratory2_bayesmodel_default)
summary(exploratory2_bayesmodel_informed)
```

### Hypothesis test

Frequentist tests of interaction effects

```{r}
# Coefficient estimate
coef2_freqV <- exploratory2_freqmodel$coefficients["composite_political_orientation_z:conditionCompetitive"]
coef2_freqA <- exploratory2_freqmodel$coefficients["composite_political_orientation_z:conditionCooperative"]

# Confidence interval
confint2_freqV <- confint(exploratory2_freqmodel, "composite_political_orientation_z:conditionCompetitive")
confint2_freqA <- confint(exploratory2_freqmodel, "composite_political_orientation_z:conditionCooperative")

# 90% Confidence interval
confint2_freqV90 <- confint(exploratory2_freqmodel, "composite_political_orientation_z:conditionCompetitive", prob = 0.90)
confint2_freqA90 <- confint(exploratory2_freqmodel, "composite_political_orientation_z:conditionCooperative", prob = 0.90)

# p-Value (computed from model output as for one-sided test)
t_confirm2V <- summary(exploratory2_freqmodel)$coefficients["composite_political_orientation_z:conditionCompetitive","t value"]
t_confirm2A <- summary(exploratory2_freqmodel)$coefficients["composite_political_orientation_z:conditionCooperative","t value"]
df_confirm2 <- exploratory2_freqmodel$df.residual
p_confirm2V <- 1-pt(t_confirm2V, df_confirm2)
p_confirm2A <- 1-pt(t_confirm2A, df_confirm2)

data.frame("beta_z" = round(c(coef2_freqV, coef2_freqA), 2),
           "CI_lower" = round(c(confint2_freqV[1], confint2_freqA[1]), 2),
           "CI_upper" = round(c(confint2_freqV[2], confint2_freqA[2]), 2),
           "CI_lower_90" = round(c(confint2_freqV90[1], confint2_freqA90[1]), 2),
           "CI_upper_90" = round(c(confint2_freqV90[2], confint2_freqA90[2]), 2),
           "p value" = round(c(p_confirm2V, p_confirm2A), 3))
```


Bayesian tests of interaction effects

```{r}
# Coefficient estimate
coef2_defaultbayesV <- fixef(exploratory2_bayesmodel_default)["composite_political_orientation_z:conditionCompetitive", "Estimate"]
coef2_defaultbayesA <- fixef(exploratory2_bayesmodel_default)["composite_political_orientation_z:conditionCooperative", "Estimate"]

coef2_informedbayesV <- fixef(exploratory2_bayesmodel_informed)["composite_political_orientation_z:conditionCompetitive", "Estimate"]
coef2_informedbayesA <- fixef(exploratory2_bayesmodel_informed)["composite_political_orientation_z:conditionCooperative", "Estimate"]

# 95% Credible interval
cred2_defaultbayesV <- fixef(exploratory2_bayesmodel_default)["composite_political_orientation_z:conditionCompetitive", c("Q2.5", "Q97.5")]
cred2_defaultbayesA <- fixef(exploratory2_bayesmodel_default)["composite_political_orientation_z:conditionCooperative", c("Q2.5", "Q97.5")]

cred2_informedbayesV <- fixef(exploratory2_bayesmodel_informed)["composite_political_orientation_z:conditionCompetitive", c("Q2.5", "Q97.5")]
cred2_informedbayesA <- fixef(exploratory2_bayesmodel_informed)["composite_political_orientation_z:conditionCooperative", c("Q2.5", "Q97.5")]

# 90% Credible interval
cred90_defaultbayesV <- fixef(exploratory2_bayesmodel_default, probs = c(0.05, 0.95))["composite_political_orientation_z:conditionCompetitive", c("Q5", "Q95")]
cred90_defaultbayesA <- fixef(exploratory2_bayesmodel_default, probs = c(0.05, 0.95))["composite_political_orientation_z:conditionCooperative", c("Q5", "Q95")]

cred90_informedbayesV <- fixef(exploratory2_bayesmodel_informed, probs = c(0.05, 0.95))["composite_political_orientation_z:conditionCompetitive", c("Q5", "Q95")]
cred90_informedbayesA <- fixef(exploratory2_bayesmodel_informed, probs = c(0.05, 0.95))["composite_political_orientation_z:conditionCooperative", c("Q5", "Q95")]

# Bayes factor
exploratory2_defaultbfV <- bayesfactor_parameters(exploratory2_bayesmodel_default,
                       prior=exploratory2_priordraws_default, 
                       direction = "right", 
                       parameters = "composite_political_orientation_z:conditionCompetitive")
exploratory2_defaultbfA <- bayesfactor_parameters(exploratory2_bayesmodel_default,
                       prior=exploratory2_priordraws_default, 
                       direction = "right", 
                       parameters = "composite_political_orientation_z:conditionCooperative")

exploratory2_informedbfV <- bayesfactor_parameters(exploratory2_bayesmodel_informed,
                       prior=exploratory2_priordraws_informed, 
                       direction = "right", 
                       parameters = "composite_political_orientation_z:conditionCompetitive")
exploratory2_informedbfA <- bayesfactor_parameters(exploratory2_bayesmodel_informed,
                       prior=exploratory2_priordraws_informed, 
                       direction = "right", 
                       parameters = "composite_political_orientation_z:conditionCooperative")

# Posterior probability
postProb_defaultV <- hypothesis(exploratory2_bayesmodel_default, "composite_political_orientation_z:conditionCompetitive < -0.10")$hypothesis$Post.Prob
postProb_defaultA <- hypothesis(exploratory2_bayesmodel_default, "composite_political_orientation_z:conditionCooperative < -0.10")$hypothesis$Post.Prob

postProb_informedV <- hypothesis(exploratory2_bayesmodel_informed, "composite_political_orientation_z:conditionCompetitive < -0.10")$hypothesis$Post.Prob
postProb_informedA <- hypothesis(exploratory2_bayesmodel_informed, "composite_political_orientation_z:conditionCooperative < -0.10")$hypothesis$Post.Prob

# Interaction effect composite_political_orientation_z:conditionCompetitive
data.frame("prior" = c("default", "informed"),
           "beta_z" = round(c(coef2_defaultbayesV, coef2_informedbayesV), 2),
           "CI_lower_95" = round(c(cred2_defaultbayesV[1], cred2_informedbayesV[1]), 2),
           "CI_upper_95" = round(c(cred2_defaultbayesV[2], cred2_informedbayesV[2]), 2),
           "CI_lower_90" = round(c(cred90_defaultbayesV[1], cred90_informedbayesV[1]), 2),
           "CI_upper_90" = round(c(cred90_defaultbayesV[2], cred90_informedbayesV[2]), 2),
           "BFplus0" = round(c(exp(exploratory2_defaultbfV$log_BF), exp(exploratory2_informedbfV$log_BF)), 3),
           "PostProb" = round(c(postProb_defaultV, postProb_informedV), 2))

# Interaction effect composite_political_orientation_z:conditionCooperative
data.frame("prior" = c("default", "informed"),
           "beta_z" = round(c(coef2_defaultbayesA, coef2_informedbayesA), 2),
           "CI_lower_95" = round(c(cred2_defaultbayesA[1], cred2_informedbayesA[1]), 2),
           "CI_upper_95" = round(c(cred2_defaultbayesA[2], cred2_informedbayesA[2]), 2),
           "CI_lower_90" = round(c(cred90_defaultbayesA[1], cred90_informedbayesA[1]), 2),
           "CI_upper_90" = round(c(cred90_defaultbayesA[2], cred90_informedbayesA[2]), 2),
           "BFplus0" = round(c(exp(exploratory2_defaultbfA$log_BF), exp(exploratory2_informedbfA$log_BF)), 3),
           "PostProb" = round(c(postProb_defaultA, postProb_informedV), 2))
```

## System information (for reproducibility)

```{r}
Sys.info()[1:3]
sessionInfo()
```