---
title: "Confirmatory Analyses NHB1"
author: "Youssef Amin and Angelika Stefan"
output: html_document
---

## Load packages

```{r setup}
library(brms)
library(bayestestR)
library(rstan)
```

## Read in and combine data from Prolific and MTurk

```{r}

# Read in data from both studies
nhb1a <- read.csv('../../data/nhb1a_processed.csv')
nhb1b <- read.csv('../../data/nhb1b_processed.csv')

nhb1a$platform <- "Prolific"
nhb1b$platform <- "MTurk"

# Combine data
nhb1 <- rbind(nhb1a, nhb1b)

# Compute standardized scores for composite political orientation in the combined dataset
nhb1$z_mean_SECS <- scale(nhb1$mean_SECS)
nhb1$z_EconOrient <- scale(nhb1$EconOrient)
nhb1$z_SocOrient <- scale(nhb1$SocOrient)
nhb1$z_PolOrient <- scale(nhb1$PolOrient)
nhb1$composite_political_orientation <- rowMeans(nhb1[, c("z_mean_SECS", "z_EconOrient", "z_SocOrient", "z_PolOrient")], na.rm = TRUE)
nhb1$composite_political_orientation_z <- scale(nhb1$composite_political_orientation)

# Compute standardized scores for mean intergroup bias in the combined dataset
nhb1$z_total_ingroup_minus_outgroup_points <- scale(nhb1$total_ingroup_minus_outgroup_points)
nhb1$z_ingroup_minus_outgroup_traits_positive <- scale(nhb1$ingroup_minus_outgroup_traits_positive)
nhb1$z_ingroup_minus_outgroup_identify <- scale(nhb1$ingroup_minus_outgroup_identify)
nhb1$mean_intergroup_bias <- rowMeans(nhb1[, c("z_total_ingroup_minus_outgroup_points", "z_ingroup_minus_outgroup_traits_positive", "z_ingroup_minus_outgroup_identify")], na.rm = TRUE)
nhb1$mean_intergroup_bias_z <- scale(nhb1$mean_intergroup_bias)
```

## General note on hypothesis testing and parameter estimation strategy

We will evaluate all hypotheses first in the frequentist, then in the Bayesian framework. For the Bayesian model, we used zero-centered weakly informative prior distributions since we did not have specific prior knowledge about the effect. The seed used in the Monte Carlo sampling procedure was suggested by AS during the sequential sampling procedure for Study 2 while being blind to its potential effect on the resulting Bayes factor. We subsequently decided to use it in all analyses for simplicity. The final set of analyses was conducted on AS' computer.

## Testing ideological asymmetry in intergroup bias

### Preregistration (Stage 1 Report)

Excerpt from the Design Table:

*Is ideology related to explicit minimal group bias?*

*H0: Composite ideology is unrelated to composite intergroup bias*

*H1: Composite ideology is positively related to composite intergroup bias*

*We will examine the correlation between composite ideology and composite intergroup bias*

Excerpt from the Analysis Plan:

*Political conservatism will be associated with intergroup bias. We will use linear regression to test this hypothesis. Political ideology (the continuous composite measure) will be entered as the independent variable, and our composite intergroup bias measure will be entered as the dependent variable.*

Excerpt from the Main Hypothesis testing section:

*The existing literature (and our pilot data) does not provide clear reasons to predict that liberals may generally exhibit greater intergroup bias—rather, the competing predictions in the literature, between which we aim to adjudicate, are (1) that conservatives exhibit greater intergroup bias, or (2) there are no ideological differences in intergroup bias. Given this, we will employ one-tailed statistical tests for examining ideological differences in intergroup bias.*

*To interpret potential null results, we will conduct an inferiority test if our measure of intergroup bias either shows (1) a non-significant association with ideology and/or (2) an effect size of less than r = .10. The inferiority test operates as an equivalence test with the lower bound set to infinity. It therefore allows us to determine whether we can reject the null hypothesis that the effect is at least as large as r = .10 and examine the probability that—given an observed effect size—there exists a true effect in the population that is at least as large as the smallest effect size of interest (SESOI) 109, 75.To conduct these analyses, we will calculate the 90% confidence interval around the observed correlation between ideology and intergroup bias. If this interval does not include (or exceed) .1, we will conclude that the effect of ideology on intergroup bias either does not exist or is too small to be of any practical importance109. For example, should we find a positive but small relationship between ideology and intergroup bias of r = .05 and the 90% CI of this effect does not include (or exceed) .1, we will interpret this as evidence against the intergroup asymmetry hypothesis.*

### Combined sample

#### Model fitting

```{r}
# Define model equation
confirmatory1_formula <- mean_intergroup_bias_z ~ composite_political_orientation_z

# Fit frequentist model
confirmatory1_freqmodel <- lm(confirmatory1_formula, nhb1)

# Fit Bayesian model
confirmatory1_priors <- c(set_prior("normal(0, 0.5)", class = "b"))

confirmatory1_bayesmodel <- brm(
  formula = confirmatory1_formula, 
  data = nhb1, 
  family = gaussian(),
  prior = confirmatory1_priors,
  sample_prior = "no",
  iter = 100000,
  chains = 4,
  seed = 987654,
  silent = TRUE,
  refresh = 0,
  warmup = 5000,
  file = "./model-fits/nhb1/confirmatory1_bayesmodel"
)

confirmatory1_priordraws<- brms::brm(confirmatory1_formula, 
                            data = nhb1, 
                            family = "gaussian",
                            prior = confirmatory1_priors,
                            sample_prior = "only",
                            seed = 987654,
                            silent = TRUE,
                            refresh = 0,
                            iter = 100000,
                            file = "./model-fits/nhb1/confirmatory1_bayesmodel_priordraws")
```

#### Model summaries

```{r}
summary(confirmatory1_freqmodel)
summary(confirmatory1_bayesmodel)
```

#### Hypothesis test

Frequentist testing quantities

```{r}
# Coefficient estimate
coef1_freq <- confirmatory1_freqmodel$coefficients["composite_political_orientation_z"]

# Confidence interval
confint1_freq <- confint(confirmatory1_freqmodel, "composite_political_orientation_z")
confint90_freq <- confint(confirmatory1_freqmodel, "composite_political_orientation_z", level = 0.90)

# p-Value (computed manually as one-sided p-value)
df_confirm1 <- confirmatory1_freqmodel$df.residual
t_confirm1 <- confirmatory1_freqmodel$coefficients[["composite_political_orientation_z"]]/summary(confirmatory1_freqmodel)$coefficients["composite_political_orientation_z","Std. Error"]
p_confirm1 <- 1-pt(t_confirm1, df_confirm1)

data.frame("beta_z" = round(coef1_freq, 2),
           "CI_lower_95" = round(confint1_freq[1], 2),
           "CI_upper_95" = round(confint1_freq[2], 2),
           "CI_lower_90" = round(confint90_freq[1], 2),
           "CI_upper_90" = round(confint90_freq[2], 2),
           "p value" = round(p_confirm1, 3))
```

Bayesian testing quantities

```{r}
# Coefficient estimate
coef1_bayes <- fixef(confirmatory1_bayesmodel)["composite_political_orientation_z", "Estimate"]

# Credible interval
cred1_bayes <- fixef(confirmatory1_bayesmodel)["composite_political_orientation_z", c("Q2.5", "Q97.5")]
cred90_bayes <- fixef(confirmatory1_bayesmodel, probs = c(0.05, 0.95))["composite_political_orientation_z", c("Q5", "Q95")]

# Bayes factor
confirmatory1_bf <- bayesfactor_parameters(confirmatory1_bayesmodel,
                       prior=confirmatory1_priordraws, 
                       direction = "right", 
                       parameters = "composite_political_orientation_z")

# Posterior probability > .10
postdraws <- extract(confirmatory1_bayesmodel$fit, pars = "b_composite_political_orientation_z")
postProb <- sum(postdraws[[1]] >= 0.10) / length(postdraws[[1]])

data.frame("beta_z" = round(coef1_bayes, 2),
           "CI_lower_95" = round(cred1_bayes[1], 2),
           "CI_upper_95" = round(cred1_bayes[2], 2),
           "CI_lower_90" = round(cred90_bayes[1], 2),
           "CI_upper_90" = round(cred90_bayes[2], 2),
           "BFplus0" = round(exp(confirmatory1_bf$log_BF), 2),
           "PostProb" = round(postProb, 2))
```

### Prolific sample

#### Model fitting

```{r}
# Fit frequentist model
confirmatory1a_freqmodel <- lm(confirmatory1_formula, nhb1a)

# Fit Bayesian model
confirmatory1a_bayesmodel <- brm(
  formula = confirmatory1_formula, 
  data = nhb1a, 
  family = gaussian(),
  prior = confirmatory1_priors,
  sample_prior = "no",
  iter = 100000,
  chains = 4,
  seed = 987654,
  silent = TRUE,
  refresh = 0,
  warmup = 5000,
  file = "./model-fits/nhb1/confirmatory1a_bayesmodel"
)

confirmatory1a_priordraws<- brms::brm(confirmatory1_formula, 
                            data = nhb1a, 
                            family = "gaussian",
                            prior = confirmatory1_priors,
                            sample_prior = "only",
                            seed = 987654,
                            silent = TRUE,
                            refresh = 0,
                            iter = 100000,
                            file = "./model-fits/nhb1/confirmatory1a_bayesmodel_priordraws")
```

#### Model summaries

```{r}
summary(confirmatory1a_freqmodel)
summary(confirmatory1a_bayesmodel)
```

#### Hypothesis test

Frequentist testing quantities

```{r}
# Coefficient estimate
coef1a_freq <- confirmatory1a_freqmodel$coefficients["composite_political_orientation_z"]

# Confidence interval
confint1a_freq <- confint(confirmatory1a_freqmodel, "composite_political_orientation_z")
confint90a_freq <- confint(confirmatory1a_freqmodel, "composite_political_orientation_z", level = 0.90)

# p-Value (computed manually as one-sided p-value)
df_confirm1a <- confirmatory1a_freqmodel$df.residual
t_confirm1a <- confirmatory1a_freqmodel$coefficients[["composite_political_orientation_z"]]/summary(confirmatory1a_freqmodel)$coefficients["composite_political_orientation_z","Std. Error"]
p_confirm1a <- 1-pt(t_confirm1a, df_confirm1a)

data.frame("beta_z" = round(coef1a_freq, 2),
           "CI_lower" = round(confint1a_freq[1], 2),
           "CI_upper" = round(confint1a_freq[2], 2),
           "CI_lower_90" = round(confint90a_freq[1], 2),
           "CI_upper_90" = round(confint90a_freq[2], 2),
           "p value" = round(p_confirm1a, 3))
```

Bayesian testing quantities

```{r}
# Coefficient estimate
coef1a_bayes <- fixef(confirmatory1a_bayesmodel)["composite_political_orientation_z", "Estimate"]

# Credible interval
cred1a_bayes <- fixef(confirmatory1a_bayesmodel)["composite_political_orientation_z", c("Q2.5", "Q97.5")]
cred90a_bayes <- fixef(confirmatory1a_bayesmodel, probs = c(0.05, 0.95))["composite_political_orientation_z", c("Q5", "Q95")]

# Bayes factor
confirmatory1a_bf <- bayesfactor_parameters(confirmatory1a_bayesmodel,
                       prior=confirmatory1a_priordraws, 
                       direction = "right", 
                       parameters = "composite_political_orientation_z")

# Posterior probability > .10
postdraws <- extract(confirmatory1_bayesmodel$fit, pars = "b_composite_political_orientation_z")
postProb <- sum(postdraws[[1]] >= 0.10) / length(postdraws[[1]])

data.frame("beta_z" = round(coef1a_bayes, 2),
           "CI_lower" = round(cred1a_bayes[1], 2),
           "CI_upper" = round(cred1a_bayes[2], 2),
           "CI_lower_90" = round(cred90a_bayes[1], 2),
           "CI_upper_90" = round(cred90a_bayes[2], 2),
           "BFplus0" = round(exp(confirmatory1a_bf$log_BF), 2),
           "PostProb" = round(postProb, 2))
```

### MTurk sample

#### Model fitting

```{r}
# Fit frequentist model
confirmatory1b_freqmodel <- lm(confirmatory1_formula, nhb1b)

# Fit Bayesian model
confirmatory1b_bayesmodel <- brm(
  formula = confirmatory1_formula, 
  data = nhb1b, 
  family = gaussian(),
  prior = confirmatory1_priors,
  sample_prior = "no",
  iter = 100000,
  chains = 4,
  seed = 987654,
  silent = TRUE,
  refresh = 0,
  warmup = 5000,
  file = "./model-fits/nhb1/confirmatory1b_bayesmodel"
)

confirmatory1b_priordraws<- brms::brm(confirmatory1_formula, 
                            data = nhb1b, 
                            family = "gaussian",
                            prior = confirmatory1_priors,
                            sample_prior = "only",
                            seed = 987654,
                            silent = TRUE,
                            refresh = 0,
                            iter = 100000,
                            file = "./model-fits/nhb1/confirmatory1b_bayesmodel_priordraws")
```

#### Model summaries

```{r}
summary(confirmatory1b_freqmodel)
summary(confirmatory1b_bayesmodel)
```

#### Hypothesis test

Frequentist testing quantities

```{r}
# Coefficient estimate
coef1b_freq <- confirmatory1b_freqmodel$coefficients["composite_political_orientation_z"]

# Confidence interval
confint1b_freq <- confint(confirmatory1b_freqmodel, "composite_political_orientation_z")
confint90b_freq <- confint(confirmatory1b_freqmodel, "composite_political_orientation_z", level = 0.90)

# p-Value (computed manually as one-sided p-value)
df_confirm1b <- confirmatory1b_freqmodel$df.residual
t_confirm1b <- confirmatory1b_freqmodel$coefficients[["composite_political_orientation_z"]]/summary(confirmatory1b_freqmodel)$coefficients["composite_political_orientation_z","Std. Error"]
p_confirm1b <- 1-pt(t_confirm1b, df_confirm1b)

data.frame("beta_z" = round(coef1b_freq, 2),
           "CI_lower" = round(confint1b_freq[1], 2),
           "CI_upper" = round(confint1b_freq[2], 2),
           "CI_lower_90" = round(confint90b_freq[1], 2),
           "CI_upper_90" = round(confint90b_freq[2], 2),
           "p value" = round(p_confirm1b, 3))
```

Bayesian testing quantities

```{r}
# Coefficient estimate
coef1b_bayes <- fixef(confirmatory1b_bayesmodel)["composite_political_orientation_z", "Estimate"]

# Credible interval
cred1b_bayes <- fixef(confirmatory1b_bayesmodel)["composite_political_orientation_z", c("Q2.5", "Q97.5")]
cred90b_bayes <- fixef(confirmatory1b_bayesmodel, probs = c(0.05, 0.95))["composite_political_orientation_z", c("Q5", "Q95")]

# Bayes factor
confirmatory1b_bf <- bayesfactor_parameters(confirmatory1b_bayesmodel,
                       prior=confirmatory1b_priordraws, 
                       direction = "right", 
                       parameters = "composite_political_orientation_z")

# Posterior probability > .10
postdraws <- extract(confirmatory1_bayesmodel$fit, pars = "b_composite_political_orientation_z")
postProb <- sum(postdraws[[1]] >= 0.10) / length(postdraws[[1]])

data.frame("beta_z" = round(coef1b_bayes, 2),
           "CI_lower" = round(cred1b_bayes[1], 2),
           "CI_upper" = round(cred1b_bayes[2], 2),
           "CI_lower_90" = round(cred90b_bayes[1], 2),
           "CI_upper_90" = round(cred90b_bayes[2], 2),
           "BFplus0" = round(exp(confirmatory1b_bf$log_BF), 2),
           "PostProb" = round(postProb, 2))
```

## Testing moderating effect of platform on ideological asymmetry in intergroup bias

### Preregistration (Stage 1 Report)

Excerpt from the Design Table:

*Does sample moderate ideological differences in minimal group bias? (combined S1A and S1B datasets)*

*H0: Sample does not moderate the relationship between ideology and minimal group bias*

*H1: Sample does moderate the relationship between ideology and minimal group bias*

*We will regress a sample type categorical moderator variable and continuous composite ideology score and their interaction onto composite intergroup bias*

Excerpt from the Analysis Plan:

*We will examine whether the size or nature of the association between ideology and intergroup bias differs meaningfully as a function of the specific sample—i.e., the national sample versus the MTurk sample with conservative oversample. We will combine the two datasets, adding sample type as a categorical moderator variable. We will then examine the interaction between sample type and ideology on our composite measure of intergroup bias. If the interaction is significant at p < .05 we will conduct simple slopes analyses to examine to what degree the size and/or direction of the effect differs between samples.*

### Model fitting

```{r}
# Define model equation
confirmatory2_formula <- mean_intergroup_bias_z ~ composite_political_orientation_z + platform + composite_political_orientation_z:platform

# Fit frequentist model
confirmatory2_freqmodel <- lm(confirmatory2_formula, data = nhb1)

# Fit Bayesian model
confirmatory2_priors <- c(
  set_prior("normal(0, 0.5)", class = "b", coef="composite_political_orientation_z"),
  set_prior("normal(0, 0.5)", class = "b", coef="platformProlific"),
  set_prior("normal(0, 0.2)", class = "b", coef="composite_political_orientation_z:platformProlific")
  )

confirmatory2_bayesmodel <- brms::brm(
  formula = confirmatory2_formula,
  data = nhb1,
  family = "gaussian",
  prior = confirmatory2_priors,
  iter = 100000,
  chains = 4,
  seed = 987654,
  silent = TRUE,
  refresh = 0,
  warmup = 5000,
  file = "./model-fits/nhb1/confirmatory2_bayesmodel"
)

confirmatory2_priordraws <- brms::brm(
  confirmatory2_formula,
  data = nhb1, 
  family = "gaussian",
  prior = confirmatory2_priors,
  sample_prior = "only",
  seed = 987654,
  silent = TRUE,
  refresh = 0,
  iter = 100000,
  file = "./model-fits/nhb1/confirmatory2_bayesmodel_priordraws")
```

### Model summaries

```{r}
summary(confirmatory2_freqmodel)
summary(confirmatory2_bayesmodel)
```

### Hypothesis test

Frequentist testing quantities

```{r}
# Coefficient estimate
coef2_freq <- confirmatory2_freqmodel$coefficients["composite_political_orientation_z:platformProlific"]

# Confidence interval
confint2_freq <- confint(confirmatory2_freqmodel, "composite_political_orientation_z:platformProlific")

# p-Value (extracted from model summary for two-sided test)
p_confirm2 <- summary(confirmatory2_freqmodel)$coefficients["composite_political_orientation_z:platformProlific","Pr(>|t|)"]

data.frame("beta_z" = round(coef2_freq, 2),
           "CI_lower" = round(confint2_freq[1], 2),
           "CI_upper" = round(confint2_freq[2], 2),
           "p value" = round(p_confirm2, 3))
```

Bayesian testing quantities

```{r}
# Coefficient estimate
coef2_bayes <- fixef(confirmatory2_bayesmodel)["composite_political_orientation_z:platformProlific", "Estimate"]

# Credible interval
cred2_bayes <- fixef(confirmatory2_bayesmodel)["composite_political_orientation_z:platformProlific", c("Q2.5", "Q97.5")]

# Bayes factor
confirmatory2_bf <- bayesfactor_parameters(confirmatory2_bayesmodel,
                       prior=confirmatory2_priordraws, 
                       direction = "two-sided", 
                       parameters = "composite_political_orientation_z:platformProlific")

data.frame("beta_z" = round(coef2_bayes, 2),
           "CI_lower" = round(cred2_bayes[1], 2),
           "CI_upper" = round(cred2_bayes[2], 2),
           "BF10" = round(exp(confirmatory2_bf$log_BF), 2))
```

## System information (for reproducibility)

```{r}
Sys.info()[1:3]
sessionInfo()
```